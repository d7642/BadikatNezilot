<!doctype html>
<html lang="he" dir="rtl" data-theme="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CyberScan Pro ‚Äî Ultimate Client-Side Auditor</title>
    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --bg: #0d1117; 
            --panel: #161b22; 
            --border: #30363d;
            --text-main: #c9d1d9; 
            --text-muted: #8b949e;
            --accent: #238636; /* GitHub Greenish */
            --accent-hover: #2ea043;
            --danger: #da3633;
            --warn: #d29922;
            --info: #58a6ff;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            --shadow: 0 8px 24px rgba(0,0,0,0.5);
        }

        [data-theme="light"] {
            --bg: #ffffff; 
            --panel: #f6f8fa; 
            --border: #d0d7de;
            --text-main: #24292f; 
            --text-muted: #57606a;
            --accent: #1f883d;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text-main); font-family: var(--font-stack); font-size: 14px; line-height: 1.5; transition: background 0.3s, color 0.3s; }
        
        /* --- LAYOUT --- */
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        
        /* --- HEADER --- */
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 20px; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .brand { display: flex; align-items: center; gap: 12px; }
        .logo { width: 40px; height: 40px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; font-weight: bold; }
        .brand h1 { margin: 0; font-size: 22px; font-weight: 600; }
        
        .toolbar { display: flex; gap: 10px; align-items: center; }
        
        /* --- BUTTONS --- */
        button { cursor: pointer; font-family: inherit; }
        .btn { padding: 8px 16px; border-radius: 6px; border: 1px solid rgba(27,31,36,0.15); font-weight: 600; font-size: 14px; transition: 0.2s; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: var(--accent); color: white; border: 1px solid rgba(240,246,252,0.1); }
        .btn-primary:hover:not(:disabled) { background: var(--accent-hover); }
        .btn-secondary { background: var(--panel); color: var(--text-main); border: 1px solid var(--border); }
        .btn-secondary:hover { background: rgba(177,186,196,0.12); }
        .btn:disabled { opacity: 0.5; cursor: wait; }

        select { background: var(--panel); color: var(--text-main); border: 1px solid var(--border); padding: 8px; border-radius: 6px; }

        /* --- STATS --- */
        .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: var(--panel); border: 1px solid var(--border); padding: 15px; border-radius: 8px; text-align: center; }
        .stat-val { font-size: 24px; font-weight: 700; display: block; }
        .stat-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- WARNING BOX --- */
        .disclaimer { background: rgba(210, 153, 34, 0.15); border: 1px solid var(--warn); color: var(--text-main); padding: 15px; border-radius: 8px; margin-bottom: 25px; font-size: 13px; }
        .disclaimer strong { color: var(--warn); display: block; margin-bottom: 5px; }
        
        /* --- RESULTS --- */
        .categories { display: flex; flex-direction: column; gap: 15px; }
        
        .card { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .card-header { padding: 12px 15px; background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; }
        .card-header:hover { background: rgba(255,255,255,0.05); }
        .card-title { font-weight: 600; display: flex; align-items: center; gap: 10px; }
        
        .card-body { display: none; padding: 0; }
        .card.open .card-body { display: block; }

        .check-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border); transition: background 0.1s; }
        .check-row:last-child { border-bottom: none; }
        .check-row:hover { background: rgba(255,255,255,0.02); }
        
        .check-info { flex: 1; }
        .check-name { font-weight: 500; display: block; }
        .check-desc { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        
        .check-status { text-align: right; margin-left: 15px; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .badge.good { background: rgba(46, 160, 67, 0.2); color: #3fb950; border: 1px solid rgba(46, 160, 67, 0.4); }
        .badge.warn { background: rgba(210, 153, 34, 0.2); color: #d29922; border: 1px solid rgba(210, 153, 34, 0.4); }
        .badge.bad  { background: rgba(248, 81, 73, 0.2); color: #f85149; border: 1px solid rgba(248, 81, 73, 0.4); }
        .badge.info { background: rgba(56, 139, 253, 0.2); color: #58a6ff; border: 1px solid rgba(56, 139, 253, 0.4); }
        
        .check-val { font-family: monospace; font-size: 11px; opacity: 0.8; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* --- LOGS --- */
        .logs-container { margin-top: 30px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .logs-header { background: #000; padding: 8px 15px; font-size: 12px; color: #8b949e; border-bottom: 1px solid #30363d; }
        #liveLogs { background: #0d1117; height: 150px; overflow-y: auto; padding: 10px; font-family: 'Consolas', monospace; font-size: 11px; color: #3fb950; }
        .log-line { margin-bottom: 2px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-ts { color: #58a6ff; margin-right: 8px; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="brand">
            <div class="logo">CS</div>
            <div>
                <h1 data-i18n="appTitle">CyberScan Pro</h1>
                <small style="color:var(--text-muted)" data-i18n="appSubtitle">Client-Side Security & Privacy Auditor</small>
            </div>
        </div>
        <div class="toolbar">
            <select id="langSelect">
                <option value="he">üáÆüá± ◊¢◊ë◊®◊ô◊™</option>
                <option value="en">üá∫üá∏ English</option>
            </select>
            <button class="btn btn-secondary" id="themeToggle">üåó</button>
            <div id="exportBtns" style="display:none; gap:5px;">
                <button class="btn btn-secondary" onclick="exportHTML()">üìÑ HTML</button>
                <button class="btn btn-secondary" onclick="exportJSON()">{} JSON</button>
            </div>
            <button class="btn btn-primary" id="startBtn" onclick="runFullScan()">
                <span data-i18n="btnStart">Run Scan</span>
            </button>
        </div>
    </header>

    <div class="disclaimer">
        <strong data-i18n="discTitle">‚ö†Ô∏è Disclaimer (Client-Side Only)</strong>
        <span data-i18n="discText">
            This tool runs entirely in your browser. It cannot check server-side configurations (like HttpOnly cookies, DB vulnerabilities, or WAFs). 
            Findings are indicators based on what JavaScript can access.
        </span>
    </div>

    <div class="stats-bar">
        <div class="stat-card">
            <span class="stat-val" id="scoreVal">‚Äî</span>
            <span class="stat-label" data-i18n="statScore">Security Score</span>
        </div>
        <div class="stat-card">
            <span class="stat-val" id="riskVal">0</span>
            <span class="stat-label" data-i18n="statRisks">Risks Found</span>
        </div>
        <div class="stat-card">
            <span class="stat-val" id="checksVal">0</span>
            <span class="stat-label" data-i18n="statChecks">Checks Run</span>
        </div>
    </div>

    <div class="categories" id="resultsArea">
        </div>

    <div class="logs-container">
        <div class="logs-header">System Terminal (Live)</div>
        <div id="liveLogs"></div>
    </div>
</div>

<script>
/**
 * CYBERSCAN PRO - ULTIMATE EDITION
 * Includes comprehensive checks, i18n, and safe DOM manipulation.
 */

// --- 1. CONFIGURATION & DICTIONARIES ---

const I18N = {
    he: {
        appTitle: "CyberScan Pro",
        appSubtitle: "◊õ◊ú◊ô ◊°◊®◊ô◊ß◊™ ◊ê◊ë◊ò◊ó◊î ◊ï◊§◊®◊ò◊ô◊ï◊™ (◊¶◊ì-◊ú◊ß◊ï◊ó)",
        btnStart: "◊î◊™◊ó◊ú ◊°◊®◊ô◊ß◊î ◊û◊ú◊ê◊î",
        btnScanning: "◊°◊ï◊®◊ß...",
        discTitle: "‚ö†Ô∏è ◊í◊ô◊ú◊ï◊ô ◊†◊ê◊ï◊™ (◊û◊í◊ë◊ú◊ï◊™ ◊ì◊§◊ì◊§◊ü)",
        discText: "◊õ◊ú◊ô ◊ñ◊î ◊®◊• ◊ë◊ì◊§◊ì◊§◊ü ◊ë◊ú◊ë◊ì. ◊î◊ï◊ê ◊ê◊ô◊†◊ï ◊ô◊õ◊ï◊ú ◊ú◊ë◊ì◊ï◊ß ◊î◊í◊ì◊®◊ï◊™ ◊©◊®◊™ (◊õ◊í◊ï◊ü ◊û◊°◊ì ◊†◊™◊ï◊†◊ô◊ù, ◊ó◊ï◊û◊™ ◊ê◊©, ◊ê◊ï ◊¢◊ï◊í◊ô◊ï◊™ HttpOnly). ◊î◊û◊û◊¶◊ê◊ô◊ù ◊û◊©◊ß◊§◊ô◊ù ◊ê◊™ ◊û◊î ◊©-JavaScript ◊ô◊õ◊ï◊ú ◊ú◊®◊ê◊ï◊™.",
        statScore: "◊¶◊ô◊ï◊ü ◊ê◊ë◊ò◊ó◊î",
        statRisks: "◊°◊ô◊õ◊ï◊†◊ô◊ù ◊©◊†◊û◊¶◊ê◊ï",
        statChecks: "◊ë◊ì◊ô◊ß◊ï◊™ ◊©◊ë◊ï◊¶◊¢◊ï",
        cats: {
            conn: "üîí ◊ó◊ô◊ë◊ï◊® ◊ï◊î◊¶◊§◊†◊î",
            xss: "üíâ ◊î◊í◊†◊î ◊û◊§◊†◊ô ◊î◊ñ◊®◊ß◊ï◊™ (XSS/DOM)",
            priv: "üïµÔ∏è ◊§◊®◊ò◊ô◊ï◊™ ◊ï◊ò◊ë◊ô◊¢◊™ ◊ê◊¶◊ë◊¢ (FP)",
            store: "üíæ ◊ê◊ó◊°◊ï◊ü ◊ï◊†◊™◊ï◊†◊ô◊ù ◊û◊ß◊ï◊û◊ô◊ô◊ù",
            env: "üåê ◊°◊ë◊ô◊ë◊™ ◊î◊®◊¶◊î ◊ï◊®◊©◊™",
            perms: "üîë ◊î◊®◊©◊ê◊ï◊™ ◊ï◊î◊™◊ß◊†◊ô◊ù"
        },
        results: { good: "◊™◊ß◊ô◊ü", bad: "◊ß◊®◊ô◊ò◊ô", warn: "◊ê◊ñ◊î◊®◊î", info: "◊ú◊ô◊ì◊ô◊¢◊î" }
    },
    en: {
        appTitle: "CyberScan Pro",
        appSubtitle: "Client-Side Security & Privacy Auditor",
        btnStart: "Start Full Scan",
        btnScanning: "Scanning...",
        discTitle: "‚ö†Ô∏è Disclaimer (Client-Side Only)",
        discText: "This tool runs entirely in your browser. It cannot check server-side configurations. Findings are indicators based on what JavaScript can access.",
        statScore: "Security Score",
        statRisks: "Risks Found",
        statChecks: "Checks Performed",
        cats: {
            conn: "üîí Connection & Encryption",
            xss: "üíâ Injection Protection (XSS/DOM)",
            priv: "üïµÔ∏è Privacy & Fingerprinting",
            store: "üíæ Storage & Data",
            env: "üåê Environment & Network",
            perms: "üîë Permissions & Devices"
        },
        results: { good: "Secure", bad: "Critical", warn: "Warning", info: "Info" }
    }
};

// --- 2. THE CHECK ENGINE (Massive List) ---

const CHECKS = [
    // --- GROUP: CONNECTION ---
    {
        id: 'https', group: 'conn',
        run: async () => ({ val: location.protocol, score: location.protocol === 'https:' ? 10 : 0, status: location.protocol === 'https:' ? 'good' : 'bad' }),
        txt: { he: { t: '◊§◊®◊ï◊ò◊ï◊ß◊ï◊ú HTTPS', d: '◊î◊ê◊ù ◊î◊™◊ß◊©◊ï◊®◊™ ◊û◊ï◊¶◊§◊†◊™.' }, en: { t: 'HTTPS Protocol', d: 'Is communication encrypted.' } }
    },
    {
        id: 'hsts', group: 'conn',
        run: async () => ({ val: 'Hidden from JS', score: 0, status: 'info' }),
        txt: { he: { t: '◊ê◊õ◊ô◊§◊™ HSTS', d: '◊ú◊ê ◊†◊ô◊™◊ü ◊ú◊ï◊ï◊ì◊ê ◊ë◊¶◊ì ◊ú◊ß◊ï◊ó (Header ◊©◊®◊™).' }, en: { t: 'HSTS Enforcement', d: 'Cannot verify client-side (Server Header).' } }
    },
    {
        id: 'upgrade_insecure', group: 'conn',
        run: async () => {
             const meta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
             const hasUpgrade = meta && meta.content.includes('upgrade-insecure-requests');
             return { val: hasUpgrade ? 'Yes' : 'No', score: hasUpgrade ? 5 : 0, status: hasUpgrade ? 'good' : 'info' };
        },
        txt: { he: { t: '◊©◊ì◊®◊ï◊í ◊ë◊ß◊©◊ï◊™ (CSP)', d: '◊î◊ê◊ù ◊û◊ï◊í◊ì◊® upgrade-insecure-requests.' }, en: { t: 'Upgrade Insecure Requests', d: 'CSP directive check.' } }
    },

    // --- GROUP: XSS / INJECTION ---
    {
        id: 'csp_meta', group: 'xss',
        run: async () => {
            const meta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
            return { val: meta ? 'Found' : 'Missing', score: meta ? 10 : 0, status: meta ? 'good' : 'warn' };
        },
        txt: { he: { t: 'CSP (Meta Tag)', d: '◊î◊í◊†◊î ◊ë◊°◊ô◊°◊ô◊™ ◊û◊§◊†◊ô XSS.' }, en: { t: 'CSP (Meta Tag)', d: 'Basic XSS protection.' } }
    },
    {
        id: 'xframe', group: 'xss',
        run: async () => ({ val: (window.self !== window.top) ? 'In Iframe' : 'Top Level', score: 0, status: (window.self !== window.top) ? 'info' : 'good' }),
        txt: { he: { t: '◊ë◊ì◊ô◊ß◊™ Iframe', d: '◊î◊ê◊ù ◊î◊ê◊™◊® ◊†◊ò◊¢◊ü ◊ë◊™◊ï◊ö ◊ê◊™◊® ◊ê◊ó◊® (Clickjacking).' }, en: { t: 'Iframe Check', d: 'Is site loaded inside another (Clickjacking).' } }
    },
    {
        id: 'opener', group: 'xss',
        run: async () => ({ val: window.opener ? 'Present' : 'Null', score: window.opener ? -5 : 0, status: window.opener ? 'warn' : 'good' }),
        txt: { he: { t: 'Window Opener', d: '◊°◊õ◊†◊™ Reverse Tabnabbing.' }, en: { t: 'Window Opener', d: 'Reverse Tabnabbing risk.' } }
    },
    {
        id: 'url_xss', group: 'xss',
        run: async () => {
            const risky = location.href.includes('<') || location.href.includes('javascript:');
            return { val: risky ? 'Detected' : 'Clean', score: risky ? -10 : 0, status: risky ? 'bad' : 'good' };
        },
        txt: { he: { t: '◊î◊ñ◊®◊ß◊î ◊ë-URL', d: '◊™◊ï◊ï◊ô◊ù ◊û◊°◊ï◊õ◊†◊ô◊ù ◊ë◊©◊ï◊®◊™ ◊î◊õ◊™◊ï◊ë◊™.' }, en: { t: 'URL Injection', d: 'Dangerous chars in address bar.' } }
    },

    // --- GROUP: PRIVACY / FINGERPRINTING ---
    {
        id: 'canvas_fp', group: 'priv',
        run: async () => ({ val: 'API Available', score: -5, status: 'warn' }),
        txt: { he: { t: 'Canvas Fingerprint', d: '◊ô◊õ◊ï◊ú◊™ ◊ú◊ñ◊î◊ï◊™ ◊û◊õ◊©◊ô◊® ◊ú◊§◊ô ◊®◊ô◊†◊ì◊ï◊® ◊í◊®◊§◊ô.' }, en: { t: 'Canvas Fingerprint', d: 'Device ID via graphic rendering.' } }
    },
    {
        id: 'ua_info', group: 'priv',
        run: async () => ({ val: navigator.userAgent.substring(0, 30) + '...', score: 0, status: 'info' }),
        txt: { he: { t: 'User Agent', d: '◊û◊ô◊ì◊¢ ◊¢◊ú ◊î◊ì◊§◊ì◊§◊ü ◊ï◊û◊¢◊®◊õ◊™ ◊î◊î◊§◊¢◊ú◊î.' }, en: { t: 'User Agent', d: 'Browser and OS info.' } }
    },
    {
        id: 'do_not_track', group: 'priv',
        run: async () => ({ val: navigator.doNotTrack || 'Unset', score: navigator.doNotTrack === '1' ? 5 : 0, status: 'info' }),
        txt: { he: { t: 'Do Not Track', d: '◊ë◊ß◊©◊™ ◊û◊©◊™◊û◊© ◊ú◊û◊†◊ô◊¢◊™ ◊û◊¢◊ß◊ë.' }, en: { t: 'Do Not Track', d: 'User tracking preference.' } }
    },
    {
        id: 'gpc', group: 'priv',
        run: async () => ({ val: navigator.globalPrivacyControl ? 'Yes' : 'No', score: 0, status: navigator.globalPrivacyControl ? 'good' : 'info' }),
        txt: { he: { t: 'Global Privacy Control', d: '◊™◊ß◊ü ◊§◊®◊ò◊ô◊ï◊™ ◊ó◊ì◊©.' }, en: { t: 'Global Privacy Control', d: 'New privacy standard.' } }
    },
    
    // --- GROUP: STORAGE ---
    {
        id: 'cookies_js', group: 'store',
        run: async () => ({ val: document.cookie ? 'Accessible' : 'Empty/Protected', score: document.cookie ? -5 : 5, status: document.cookie ? 'warn' : 'good' }),
        txt: { he: { t: '◊í◊ô◊©◊™ JS ◊ú◊¢◊ï◊í◊ô◊ï◊™', d: '◊¢◊ï◊í◊ô◊ï◊™ ◊ú◊ú◊ê HttpOnly ◊ó◊©◊ï◊§◊ï◊™ ◊ú◊í◊†◊ô◊ë◊î.' }, en: { t: 'JS Cookie Access', d: 'Cookies without HttpOnly are exposed.' } }
    },
    {
        id: 'local_storage', group: 'store',
        run: async () => ({ val: `${localStorage.length} items`, score: 0, status: localStorage.length > 0 ? 'info' : 'good' }),
        txt: { he: { t: 'LocalStorage', d: '◊§◊®◊ô◊ò◊ô◊ù ◊©◊û◊ï◊®◊ô◊ù ◊ë◊ì◊§◊ì◊§◊ü ◊ú◊¶◊û◊ô◊™◊ï◊™.' }, en: { t: 'LocalStorage', d: 'Persisted browser data.' } }
    },
    {
        id: 'session_storage', group: 'store',
        run: async () => ({ val: `${sessionStorage.length} items`, score: 0, status: 'info' }),
        txt: { he: { t: 'SessionStorage', d: '◊û◊ô◊ì◊¢ ◊ñ◊û◊†◊ô ◊ú◊°◊©◊ü ◊î◊†◊ï◊õ◊ó◊ô.' }, en: { t: 'SessionStorage', d: 'Temporary session data.' } }
    },

    // --- GROUP: ENV / NETWORK ---
    {
        id: 'referrer', group: 'env',
        run: async () => ({ val: document.referrerPolicy || 'Default', score: document.referrerPolicy ? 5 : 0, status: document.referrerPolicy ? 'good' : 'warn' }),
        txt: { he: { t: 'Referrer Policy', d: '◊ì◊ú◊ô◊§◊™ ◊û◊ô◊ì◊¢ ◊ë◊û◊¢◊ë◊® ◊ë◊ô◊ü ◊ê◊™◊®◊ô◊ù.' }, en: { t: 'Referrer Policy', d: 'Info leak between sites.' } }
    },
    {
        id: 'webrtc', group: 'env',
        run: async () => ({ val: window.RTCPeerConnection ? 'Active' : 'Disabled', score: -5, status: window.RTCPeerConnection ? 'warn' : 'good' }),
        txt: { he: { t: 'WebRTC Leak', d: '◊§◊ï◊ò◊†◊¶◊ô◊ê◊ú ◊ú◊ó◊©◊ô◊§◊™ IP ◊ê◊û◊ô◊™◊ô (VPN Bypass).' }, en: { t: 'WebRTC Leak', d: 'Potential Real IP Leak.' } }
    },
    {
        id: 'connection', group: 'env',
        run: async () => ({ val: navigator.connection ? navigator.connection.effectiveType : 'Unknown', score: 0, status: 'info' }),
        txt: { he: { t: 'Network Info', d: '◊°◊ï◊í ◊ó◊ô◊ë◊ï◊® ◊®◊©◊™.' }, en: { t: 'Network Info', d: 'Connection type.' } }
    },

    // --- GROUP: PERMISSIONS & HW ---
    {
        id: 'geo_perm', group: 'perms',
        run: async () => {
            try { const s = await navigator.permissions.query({name:'geolocation'}); return { val: s.state, score: s.state==='granted'?-10:0, status: s.state==='granted'?'bad':'good' }; }
            catch(e) { return { val: 'Unknown', score: 0, status: 'info' }; }
        },
        txt: { he: { t: '◊î◊®◊©◊ê◊™ ◊û◊ô◊ß◊ï◊ù', d: '◊í◊ô◊©◊î ◊ú-GPS.' }, en: { t: 'Geolocation', d: 'GPS Access.' } }
    },
    {
        id: 'cam_perm', group: 'perms',
        run: async () => {
             try { const s = await navigator.permissions.query({name:'camera'}); return { val: s.state, score: s.state==='granted'?-10:0, status: s.state==='granted'?'bad':'good' }; }
             catch(e) { return { val: 'Check Blocked', score: 0, status: 'info' }; }
        },
        txt: { he: { t: '◊î◊®◊©◊ê◊™ ◊û◊¶◊ú◊û◊î', d: '◊í◊ô◊©◊î ◊ú◊û◊¶◊ú◊û◊™ ◊®◊©◊™.' }, en: { t: 'Camera', d: 'Webcam Access.' } }
    },
    {
        id: 'battery', group: 'perms',
        run: async () => {
            if(navigator.getBattery) { const b = await navigator.getBattery(); return { val: `${Math.round(b.level*100)}%`, score: 0, status: 'warn' }; }
            return { val: 'API Unsupported', score: 0, status: 'good' };
        },
        txt: { he: { t: 'Battery API', d: '◊©◊ô◊û◊ï◊© ◊ë◊°◊ï◊ú◊ú◊î ◊ú◊û◊¢◊ß◊ë.' }, en: { t: 'Battery API', d: 'Tracking via battery status.' } }
    },
    {
        id: 'hardware', group: 'perms',
        run: async () => ({ val: `Cores: ${navigator.hardwareConcurrency || '?'}`, score: 0, status: 'info' }),
        txt: { he: { t: '◊ó◊ï◊û◊®◊™ ◊û◊õ◊©◊ô◊®', d: '◊ú◊ô◊ë◊ï◊™ ◊û◊¢◊ë◊ì (Fingerprinting).' }, en: { t: 'Hardware Info', d: 'CPU Cores (Fingerprinting).' } }
    }
];

// --- 3. CORE LOGIC ---

let currentLang = 'he';
let scanResults = null;

const $ = id => document.getElementById(id);
const escapeHTML = str => {
    if(typeof str !== 'string') return str;
    return str.replace(/[&<>'"]/g, tag => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"': '&quot;'}[tag]));
};

function log(msg) {
    const box = $('liveLogs');
    const d = new Date().toLocaleTimeString();
    box.innerHTML += `<div class="log-line"><span class="log-ts">[${d}]</span>${escapeHTML(msg)}</div>`;
    box.scrollTop = box.scrollHeight;
}

function setLang(lang) {
    currentLang = lang;
    document.documentElement.lang = lang;
    document.documentElement.dir = lang === 'he' ? 'rtl' : 'ltr';
    
    // Update simple UI texts
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if(I18N[lang][key]) el.textContent = I18N[lang][key];
    });

    // If results exist, re-render them in new language
    if(scanResults) renderResults();
}

async function runFullScan() {
    log('Initializing scan engine...');
    const btn = $('startBtn');
    btn.disabled = true;
    btn.innerHTML = `‚è≥ ${I18N[currentLang].btnScanning}`;
    
    scanResults = { items: [], score: 100, risks: 0 };
    const items = [];
    
    // Clean UI
    $('resultsArea').innerHTML = '';
    
    for(const check of CHECKS) {
        log(`Running check: ${check.id}...`);
        try {
            const res = await check.run();
            // Calculate score (simple logic: start at 100, deduct for bad things)
            if(res.status === 'bad') { scanResults.score -= 10; scanResults.risks++; }
            if(res.status === 'warn') { scanResults.score -= 5; scanResults.risks++; }
            
            items.push({ ...check, result: res });
        } catch(e) {
            log(`Error in ${check.id}: ${e.message}`);
        }
    }
    
    scanResults.score = Math.max(0, scanResults.score);
    scanResults.items = items;
    scanResults.date = new Date().toISOString();

    updateStats();
    renderResults();
    
    $('exportBtns').style.display = 'flex';
    btn.disabled = false;
    btn.textContent = I18N[currentLang].btnStart;
    log(`Scan complete. Score: ${scanResults.score}`);
}

function updateStats() {
    $('scoreVal').textContent = scanResults.score;
    $('scoreVal').style.color = scanResults.score > 80 ? 'var(--accent)' : (scanResults.score > 50 ? 'var(--warn)' : 'var(--danger)');
    $('riskVal').textContent = scanResults.risks;
    $('checksVal').textContent = scanResults.items.length;
}

function renderResults() {
    const area = $('resultsArea');
    area.innerHTML = '';
    
    // Group by category
    const groups = {};
    scanResults.items.forEach(item => {
        if(!groups[item.group]) groups[item.group] = [];
        groups[item.group].push(item);
    });

    for(const [grpId, items] of Object.entries(groups)) {
        const catName = I18N[currentLang].cats[grpId] || grpId;
        const card = document.createElement('div');
        card.className = 'card open'; // Default open
        
        let rowsHtml = '';
        items.forEach(item => {
            const txt = item.txt[currentLang];
            rowsHtml += `
                <div class="check-row">
                    <div class="check-info">
                        <span class="check-name">${escapeHTML(txt.t)}</span>
                        <span class="check-desc">${escapeHTML(txt.d)}</span>
                    </div>
                    <div class="check-status">
                        <span class="badge ${item.result.status}">${I18N[currentLang].results[item.result.status]}</span>
                        <span class="check-val">${escapeHTML(String(item.result.val))}</span>
                    </div>
                </div>
            `;
        });

        card.innerHTML = `
            <div class="card-header" onclick="this.parentElement.classList.toggle('open')">
                <div class="card-title">${escapeHTML(catName)}</div>
                <span>‚ñº</span>
            </div>
            <div class="card-body">${rowsHtml}</div>
        `;
        area.appendChild(card);
    }
}

// --- 4. EXPORT FUNCTIONS ---

function exportJSON() {
    if(!scanResults) return;
    const blob = new Blob([JSON.stringify(scanResults, null, 2)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'cyberscan_results.json';
    a.click();
}

function exportHTML() {
    if(!scanResults) return;
    // We recreate a standalone HTML report
    let htmlBody = `<h1>CyberScan Report</h1><p>Date: ${scanResults.date}</p><hr>`;
    
    scanResults.items.forEach(item => {
        const txt = item.txt[currentLang];
        htmlBody += `<div style="padding:10px; border-bottom:1px solid #ccc">
            <strong>${escapeHTML(txt.t)}</strong> [${item.result.status.toUpperCase()}]<br>
            <small>${escapeHTML(txt.d)}</small><br>
            Value: <code>${escapeHTML(String(item.result.val))}</code>
        </div>`;
    });

    const fullHtml = `<!DOCTYPE html><html dir="${currentLang==='he'?'rtl':'ltr'}">
    <head><meta charset="utf-8"><title>Report</title><style>body{font-family:sans-serif;padding:20px;}</style></head>
    <body>${htmlBody}</body></html>`;

    const blob = new Blob([fullHtml], {type: 'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'cyberscan_report.html';
    a.click();
}

// --- 5. INIT ---

$('langSelect').addEventListener('change', (e) => setLang(e.target.value));
$('themeToggle').addEventListener('click', () => {
    const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
    document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
});

// Set initial state
setLang('he');

</script>
</body>
</html>
