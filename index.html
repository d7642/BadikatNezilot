<!doctype html>
<html lang="he" dir="rtl" data-theme="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" data-i18n="metaDescription" content="Client-Side Privacy Scanner">
    <title data-i18n="title">CyberScan Pro â€” Web Security & Privacy Deep Scan</title>

    <style>
        /* --- Styles --- */
        :root {
            --bg: #060709; --panel: #0f1216; --text-main: #e6eef6; --text-muted: #98a2ad;
            --accent: #d33b3b; --accent2: #1f6feb; --good: #39b54a; --warn: #ffb86b; --bad: #ff5c5c;
            --glass: rgba(255, 255, 255, 0.03); --border: rgba(255, 255, 255, 0.06); --shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
            --font-stack: "Segoe UI", "Helvetica Neue", Arial, system-ui, sans-serif;
        }

        [data-theme="light"] {
            --bg: #f0f2f5; --panel: #ffffff; --text-main: #1c1e21; --text-muted: #606770;
            --accent: #d93025; --glass: rgba(0, 0, 0, 0.03); --border: rgba(0, 0, 0, 0.1); --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text-main); font-family: var(--font-stack); scroll-behavior: smooth; transition: background 0.3s ease, color 0.3s ease; }
        #scrollProgress { position: fixed; top: 0; left: 0; width: 0%; height: 3px; background: linear-gradient(90deg, var(--accent), var(--accent2)); z-index: 9999; transition: width 0.1s; }
        .app { max-width: 920px; margin: 20px auto; padding: 10px; padding-bottom: 80px; }
        
        /* Header & Controls */
        header { display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .brand { display: flex; align-items: center; gap: 12px; }
        .logo { width: 56px; height: 56px; border-radius: 10px; background: linear-gradient(135deg, var(--accent), #7b1515); display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 16px; color: white; box-shadow: 0 4px 15px rgba(211, 59, 59, 0.4); }
        .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        
        .btn { background: linear-gradient(90deg, var(--accent), #b72626); border: 0; padding: 10px 18px; border-radius: 8px; color: white; font-weight: 700; cursor: pointer; transition: transform 0.1s, filter 0.2s; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; font-size: 14px; }
        .btn:hover { filter: brightness(1.1); }
        .btn:active { transform: scale(0.96); }
        .btn.secondary { background: var(--glass); border: 1px solid var(--border); color: var(--text-main); }
        .btn.secondary:hover { background: rgba(255,255,255,0.1); }
        
        .lang-select { background: var(--panel); color: var(--text-main); border: 1px solid var(--border); padding: 8px; border-radius: 6px; }
        .btn-icon { background: transparent; border: none; font-size: 20px; cursor: pointer; padding: 5px; }

        /* Cards and Results */
        .results { display: flex; flex-direction: column; gap: 12px; }
        .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 12px 16px; box-shadow: var(--shadow); position: relative; }
        .card .drag-handle { position: absolute; top: 10px; right: 10px; cursor: grab; opacity: 0.3; font-size: 16px; }
        [dir="ltr"] .card .drag-handle { left: 10px; right: auto; }
        .card.dragging { opacity: 0.5; border: 2px dashed var(--accent); }
        .card .head { display: flex; align-items: center; justify-content: space-between; gap: 10px; cursor: pointer; padding: 4px 0; }
        .card .title { font-weight: 800; font-size: 15px; }
        .card .desc { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        .chev { transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); color: var(--text-muted); }
        [dir="rtl"] .chev { transform: rotate(180deg); }
        [dir="rtl"] .expanded .chev { transform: rotate(90deg); }
        [dir="ltr"] .chev { transform: rotate(0deg); }
        [dir="ltr"] .expanded .chev { transform: rotate(90deg); }
        .details { overflow: hidden; max-height: 0; transition: max-height 0.4s ease-out, opacity 0.4s ease; opacity: 0; padding-top: 0; }
        .expanded .details { max-height: 3000px; opacity: 1; padding-top: 10px; border-top: 1px solid var(--border); margin-top: 8px; }
        
        /* Lists & Badges */
        .line { display: flex; justify-content: space-between; font-size: 13px; padding: 6px 0; border-bottom: 1px dashed var(--border); }
        .line:last-child { border-bottom: none; }
        .line strong { color: var(--text-main); }
        .badge { font-size: 11px; padding: 4px 8px; border-radius: 6px; font-weight: 700; }
        .badge.good { background: rgba(57, 181, 74, 0.15); color: var(--good); }
        .badge.warn { background: rgba(255, 184, 107, 0.15); color: var(--warn); }
        .badge.bad { background: rgba(255, 92, 92, 0.15); color: var(--bad); }
        
        .risk-detail { margin-top: 10px; padding: 10px; border-radius: 8px; font-size: 12px; border-left: 4px solid; }
        .risk-detail.bad { border-color: var(--bad); background: rgba(255, 92, 92, 0.1); }
        .risk-detail.warn { border-color: var(--warn); background: rgba(255, 184, 107, 0.1); }
        .risk-detail.good { border-color: var(--good); background: rgba(57, 181, 74, 0.1); }
        .risk-detail h5 { margin-top: 0; font-size: 13px; margin-bottom: 5px; }
        
        /* Log Console */
        #liveLogs { background: #000; color: #0f0; font-family: 'Consolas', monospace; font-size: 11px; height: 150px; overflow-y: auto; padding: 10px; border-radius: 8px; border: 1px solid #333; margin-top: 15px; display: flex; flex-direction: column-reverse; }
        .log-entry { margin: 2px 0; border-bottom: 1px solid #111; }
        .log-entry span { opacity: 0.7; margin-right: 8px; }
        
        /* Warning Card */
        .info-card { background: var(--accent); color: white; border: none; padding: 15px; border-radius: 12px; }
        .info-card ul { list-style: disc; margin-right: 20px; padding-right: 0; }
        [dir="ltr"] .info-card ul { list-style: disc; margin-left: 20px; padding-left: 0; }

    </style>
</head>

<body>
    <div id="scrollProgress"></div>

    <div class="app" role="application">
        <header>
            <div class="brand">
                <div class="logo">CSP</div>
                <div>
                    <h1 data-i18n="appTitle" style="margin:0; font-size:18px;">CyberScan Pro</h1>
                    <p data-i18n="appSubtitle" style="margin:0; font-size:12px; color:var(--text-muted);">Client-Side Deep Scan</p>
                </div>
            </div>

            <div class="controls">
                <select id="langSelector" class="lang-select" aria-label="Select Language"></select>
                <button class="btn-icon" id="themeToggle"><span id="themeIcon">ğŸŒ™</span></button>

                <div class="score" style="display:flex; align-items:center; gap:8px;">
                    <div id="privacyScore" style="font-size:24px; font-weight:900;">â€”</div>
                    <div style="font-size:11px; color:var(--text-muted);" data-i18n="scoreLabel">Score</div>
                </div>

                <button id="downloadJsonBtn" class="btn secondary" style="display:none;">
                    { } ×”×•×¨×“ ×“×•×— JSON
                </button>

                <button id="fullBtn" class="btn">
                    <span data-i18n="fullScanBtn">ğŸ” ×”×ª×—×œ ×¡×¨×™×§×”</span>
                </button>
            </div>
        </header>

        <div class="info-card" data-id="warning">
            <h4 data-i18n="serverWarningTitle" style="margin-top:0;">âš ï¸ ×”×¢×¨×ª ××‘×˜×—×” (×¢×•×‘×“×ª×™×ª)</h4>
            <p data-i18n="serverWarningDesc" style="font-size:12px; margin-bottom: 10px;">×‘×“×™×§×•×ª ×¦×“-×œ×§×•×— ×”×Ÿ ××™× ×“×™×§×¦×™×” ×•×× ×™×¢×” ×—×œ×§×™×ª ×‘×œ×‘×“. ×œ× × ×™×ª×Ÿ ×œ×”×—×œ×™×£ ×‘×“×™×§×•×ª ×©×¨×ª (DB, ×§×•×“ ×©×¨×ª, ×—×¡×™××” ××•×—×œ×˜×ª ×©×œ XSS) ×‘×‘×“×™×§×•×ª ××œ×”.</p>
            <ul id="serverWarningList" style="font-size:12px; margin: 0; padding: 0;" data-i18n="serverWarningList"></ul>
        </div>

        <div class="results" id="resultsContainer">
            <div class="card" draggable="true" data-id="conn">
                <div class="drag-handle">::</div>
                <div class="head toggle" data-target="conn">
                    <div><div class="title" data-i18n="connTitle">1ï¸âƒ£ ×—×™×‘×•×¨ ×•×›×•×ª×¨×•×ª ××‘×˜×—×”</div>
                         <div class="desc" data-i18n="connDesc">HTTPS, Secure Context, CSP, HSTS</div></div>
                    <div class="chev">â–¼</div>
                </div>
                <div class="details"><div id="connList" class="list"></div></div>
            </div>

            <div class="card" draggable="true" data-id="script">
                <div class="drag-handle">::</div>
                <div class="head toggle" data-target="script">
                    <div><div class="title" data-i18n="scriptTitle">2ï¸âƒ£ ×§×•×“ ××¡×•×›×Ÿ ×•×”×–×¨×§×ª DOM</div>
                         <div class="desc" data-i18n="scriptDesc">eval, innerHTML, Script Injection, XSS patterns</div></div>
                    <div class="chev">â–¼</div>
                </div>
                <div class="details"><div id="scriptList" class="list"></div></div>
            </div>

            <div class="card" draggable="true" data-id="input">
                <div class="drag-handle">::</div>
                <div class="head toggle" data-target="input">
                    <div><div class="title" data-i18n="inputTitle">3ï¸âƒ£ ×§×œ×˜, ×˜×¤×¡×™× ×•××—×¡×•×Ÿ ××§×•××™</div>
                         <div class="desc" data-i18n="inputDesc">Validation, Cookies, Storage</div></div>
                    <div class="chev">â–¼</div>
                </div>
                <div class="details"><div id="inputList" class="list"></div></div>
            </div>

            <div class="card" draggable="true" data-id="fp">
                <div class="drag-handle">::</div>
                <div class="head toggle" data-target="fp">
                    <div><div class="title" data-i18n="fpTitle">4ï¸âƒ£ ×˜×‘×™×¢×ª ××¦×‘×¢ ×•×¤×¨×˜×™×•×ª (Advanced FP)</div>
                         <div class="desc" data-i18n="fpDesc">Canvas, WebGL, AudioContext, Timezone Leakage</div></div>
                    <div class="chev">â–¼</div>
                </div>
                <div class="details"><div id="fpList" class="list"></div></div>
            </div>

            <div class="card" draggable="true" data-id="perms">
                <div class="drag-handle">::</div>
                <div class="head toggle" data-target="perms">
                    <div><div class="title" data-i18n="permsTitle">5ï¸âƒ£ ×”×¨×©××•×ª ×•×—×•×§ (Legal & Privacy)</div>
                         <div class="desc" data-i18n="permsDesc">Geolocation, Clipboard, GPC, Cookie Consent</div></div>
                    <div class="chev">â–¼</div>
                </div>
                <div class="details"><div id="permsList" class="list"></div></div>
            </div>

             <div class="card" draggable="true" data-id="netrt">
                <div class="drag-handle">::</div>
                <div class="head toggle" data-target="netrt">
                    <div><div class="title" data-i18n="netrtTitle">6ï¸âƒ£ ×¨×©×ª, ×–××Ÿ ×¨×™×¦×” ×•×‘×™×¦×•×¢×™×</div>
                         <div class="desc" data-i18n="netrtDesc">WebRTC, Beacon, JS Errors, Long Tasks</div></div>
                    <div class="chev">â–¼</div>
                </div>
                <div class="details"><div id="netrtList" class="list"></div></div>
            </div>
        </div>

        <h4 style="margin: 20px 0 5px 0; font-size:13px; color:var(--accent2);" data-i18n="logTitle">Live System Logs (Client-Side)</h4>
        <div id="liveLogs"></div>
    </div>

    <div id="cookieBanner">
        <h4 style="margin:0" data-i18n="cookieTitle">ğŸª Privacy & Cookies</h4>
        <p style="font-size:12px; color:var(--text-muted); margin:0;" data-i18n="cookieDesc">We use local storage to save your preferences. No data is sent to servers.</p>
        <div class="cookie-options">
            <label><input type="checkbox" checked disabled> <span data-i18n="cookieEssential">Essential</span></label>
            <label><input type="checkbox" id="pref_analytics"> <span data-i18n="cookieAnalytics">Analytics (Mock)</span></label>
            <label><input type="checkbox" id="pref_gpc" ${navigator.globalPrivacyControl ? 'checked' : ''} disabled> <span data-i18n="cookieGPC">GPC Detected</span></label>
        </div>
        <div class="cookie-btn-group">
            <button class="btn secondary" onclick="handleCookieConsent(false)" data-i18n="cookieReject">Reject</button>
            <button class="btn" onclick="handleCookieConsent(true)" data-i18n="cookieAccept">Accept All</button>
        </div>
    </div>

    <script>
        'use strict';
        const $ = id => document.getElementById(id);
        
        function escapeHTML(str) {
            if (typeof str !== 'string') return str;
            return str.replace(/[&<>'"]/g, tag => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'}[tag]));
        }

        const Storage = {
            get: (key) => localStorage.getItem(key),
            set: (key, val) => localStorage.setItem(key, val),
        };

        function logToConsole(msg, type='info') {
            const logContainer = $('liveLogs');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `<span style="color:#888">[${time}]</span> ${escapeHTML(msg)}`;
            logContainer.insertBefore(entry, logContainer.firstChild); 
            if (logContainer.children.length > 50) logContainer.removeChild(logContainer.lastChild);
        }

        // --- Data & Translations ---
        const LANG_LIST = [{code: 'he', name: '×¢×‘×¨×™×ª', dir: 'rtl'}, {code: 'en', name: 'English', dir: 'ltr'}];
        
        const i18n = {
            'he': {
                metaDescription: '×¡×•×¨×§ ××‘×˜×—×” ×•×¤×¨×˜×™×•×ª ×¦×“-×œ×§×•×— ××ª×§×“×',
                title: 'CyberScan Pro â€” ×¡×¨×™×§×ª ××‘×˜×—×” ×•×¤×¨×˜×™×•×ª ×¢××•×§×”',
                appTitle: 'CyberScan Pro',
                appSubtitle: '×‘×“×™×§×•×ª ××‘×˜×—×” ×¦×“-×œ×§×•×— ××§×™×¤×•×ª',
                fullScanBtn: 'ğŸ” ×”×ª×—×œ ×¡×¨×™×§×” ××œ××”',
                scoreLabel: '×¦×™×•×Ÿ ××‘×˜×—×”',
                logTitle: '×œ×•×’×™× ×—×™×™× (×¦×“ ×œ×§×•×—)',
                cookieTitle: 'ğŸª ×¤×¨×˜×™×•×ª ×•×¢×•×’×™×•×ª',
                cookieDesc: '×× ×• ××©×ª××©×™× ×‘××—×¡×•×Ÿ ××§×•××™ ×œ×©××™×¨×ª ×”×¢×“×¤×•×ª. ×œ× × ×©×œ×— ××™×“×¢ ×œ×©×¨×ª×™×.',
                cookieEssential: '×—×™×•× ×™', cookieAnalytics: '×× ×œ×™×˜×™×§×” (××“×•××”)', cookieReject: '×“×—×™×™×”', cookieAccept: '××™×©×•×¨ ×”×›×œ',
                cookieGPC: 'GPC ×–×•×”×”',
                
                connTitle: '1ï¸âƒ£ ×—×™×‘×•×¨ ×•×›×•×ª×¨×•×ª ××‘×˜×—×”', connDesc: 'HTTPS, Secure Context, CSP, HSTS',
                scriptTitle: '2ï¸âƒ£ ×§×•×“ ××¡×•×›×Ÿ ×•×”×–×¨×§×ª DOM', scriptDesc: 'eval, innerHTML, Script Injection',
                inputTitle: '3ï¸âƒ£ ×§×œ×˜, ×˜×¤×¡×™× ×•××—×¡×•×Ÿ ××§×•××™', inputDesc: 'Validation, Cookies, Storage',
                fpTitle: '4ï¸âƒ£ ×˜×‘×™×¢×ª ××¦×‘×¢ ×•×¤×¨×˜×™×•×ª', fpDesc: 'Canvas, WebGL, AudioContext',
                permsTitle: '5ï¸âƒ£ ×”×¨×©××•×ª ×•×—×•×§', permsDesc: 'Geolocation, Clipboard, GPC',
                netrtTitle: '6ï¸âƒ£ ×¨×©×ª, ×–××Ÿ ×¨×™×¦×” ×•×‘×™×¦×•×¢×™×', netrtDesc: 'WebRTC, Beacon, Errors',

                serverWarningTitle: 'âš ï¸ ×”×¢×¨×ª ××‘×˜×—×” (×¢×•×‘×“×ª×™×ª)',
                serverWarningDesc: '×‘×“×™×§×•×ª ×¦×“-×œ×§×•×— ×”×Ÿ ××™× ×“×™×§×¦×™×” ×•×× ×™×¢×” ×—×œ×§×™×ª ×‘×œ×‘×“. ×œ× × ×™×ª×Ÿ ×œ×”×—×œ×™×£ ×‘×“×™×§×•×ª ×©×¨×ª.',
                serverWarningList: ['×‘×“×™×§×ª ×§×•×“ ×©×¨×ª ×•-DB ××™× ×” ××¤×©×¨×™×ª.', '×—×¡×™××” ××•×—×œ×˜×ª ×©×œ XSS ××™× ×” ××¤×©×¨×™×ª.', '×× ×™×¢×ª ××ª×§×¤×•×ª ××ª×•×—×›××•×ª ××™× ×” ××¤×©×¨×™×ª.'],
            },
            'en': {
                metaDescription: 'Advanced client-side security and privacy scanner',
                title: 'CyberScan Pro â€” Web Security & Privacy Deep Scan',
                appTitle: 'CyberScan Pro',
                appSubtitle: 'Comprehensive Client-Side Security Checks',
                fullScanBtn: 'ğŸ” Start Full Scan',
                scoreLabel: 'Security Score',
                logTitle: 'Live System Logs (Client-Side)',
                cookieTitle: 'ğŸª Privacy & Cookies',
                cookieDesc: 'We use local storage to save your preferences. No data is sent to servers.',
                cookieEssential: 'Essential', cookieAnalytics: 'Analytics (Mock)', cookieReject: 'Reject', cookieAccept: 'Accept All',
                cookieGPC: 'GPC Detected',
                
                connTitle: '1ï¸âƒ£ Connection & Security Headers', connDesc: 'HTTPS, Secure Context, CSP, HSTS',
                scriptTitle: '2ï¸âƒ£ Dangerous Code & DOM Injection', scriptDesc: 'eval, innerHTML, Script Injection',
                inputTitle: '3ï¸âƒ£ Input, Forms & Local Storage', inputDesc: 'Validation, Cookies, Storage',
                fpTitle: '4ï¸âƒ£ Advanced Fingerprinting & Privacy', fpDesc: 'Canvas, WebGL, AudioContext',
                permsTitle: '5ï¸âƒ£ Permissions & Legal', permsDesc: 'Geolocation, Clipboard, GPC',
                netrtTitle: '6ï¸âƒ£ Network, RunTime & Performance', netrtDesc: 'WebRTC, Beacon, Errors',

                serverWarningTitle: 'âš ï¸ Security Note (Factual)',
                serverWarningDesc: 'Client-side checks are only indicators. They cannot replace server-side checks.',
                serverWarningList: ['Server code/DB checks impossible.', 'Absolute XSS prevention impossible.', 'Sophisticated attack prevention impossible.'],
            }
        };

        // --- Checks Logic ---
        const CHECK_GROUPS = {
            conn: ['https', 'secure_context', 'csp', 'hsts', 'referer'],
            script: ['eval_check', 'innerhtml_check', 'xss_url', 'dom_monitor'],
            input: ['html5_validate', 'secure_cookie', 'storage_size', 'gpc_check'],
            fp: ['canvas_fp', 'webgl_fp', 'audio_fp', 'timezone_leak', 'timing_res'],
            perms: ['geo_perm', 'clipboard_perm', 'camera_perm'],
            netrt: ['ip_leak', 'fetch_api', 'long_tasks', 'js_errors'],
        };

        const CHECKS = {
            // Checks definitions (Same as before, abbreviated for brevity but functional)
            https: { group: 'conn', points: 10, check: () => ({ value: location.protocol === 'https:', result: location.protocol === 'https:' ? 'good' : 'bad' }), 
                details: { he: { title: '×‘×“×™×§×ª HTTPS ×¤×¢×™×œ', impact: '×ª×¢×‘×•×¨×” ×œ× ××•×¦×¤× ×ª.', mitigation: '×”×¤×¢×œ HSTS.' }, en: { title: 'Active HTTPS', impact: 'Unencrypted traffic.', mitigation: 'Enable HSTS.' } } },
            secure_context: { group: 'conn', points: 5, check: () => ({ value: window.isSecureContext, result: window.isSecureContext ? 'good' : 'bad' }),
                details: { he: { title: '×‘×“×™×§×ª Secure Context', impact: '×©×™××•×© ×‘-APIs ×¨×’×™×©×™×.', mitigation: '×”×©×ª××© ×‘-HTTPS.' }, en: { title: 'Secure Context', impact: 'Sensitive API usage.', mitigation: 'Use HTTPS.' } } },
            csp: { group: 'conn', points: 15, check: () => ({ value: document.querySelector('meta[http-equiv="Content-Security-Policy"]') !== null, result: document.querySelector('meta[http-equiv="Content-Security-Policy"]') ? 'warn' : 'bad' }),
                details: { he: { title: 'Content-Security-Policy', impact: '×¡×™×›×•×Ÿ ×œ-XSS.', mitigation: '×”×•×¡×£ ×›×•×ª×¨×ª CSP.' }, en: { title: 'Content-Security-Policy', impact: 'XSS risk.', mitigation: 'Add CSP header.' } } },
            hsts: { group: 'conn', points: 10, check: async () => ({ value: 'Not Available via JS', result: 'warn' }),
                details: { he: { title: 'HSTS Header', impact: '×”×•×¨×“×” ×œ-HTTP ××¤×©×¨×™×ª.', mitigation: '×”×’×“×¨ ×‘×©×¨×ª.' }, en: { title: 'HSTS Header', impact: 'Downgrade possible.', mitigation: 'Set on server.' } } },
            referer: { group: 'conn', points: 5, check: () => ({ value: document.referrerPolicy || 'None', result: document.referrerPolicy && document.referrerPolicy !== 'no-referrer' ? 'warn' : 'good' }),
                details: { he: { title: 'Referrer Policy', impact: '×“×œ×™×¤×ª ××™×“×¢ ×œ××ª×¨×™× ××—×¨×™×.', mitigation: '×”×’×“×¨ no-referrer.' }, en: { title: 'Referrer Policy', impact: 'Info leak to 3rd party.', mitigation: 'Set no-referrer.' } } },
            
            // Script
            eval_check: { group: 'script', points: 20, check: () => ({ value: 'Simulated Check', result: 'good' }),
                details: { he: { title: '×©×™××•×© ×‘-eval', impact: '×”×–×¨×§×ª ×§×•×“.', mitigation: '×”×™×× ×¢ ×-eval.' }, en: { title: 'eval() Usage', impact: 'Code Injection.', mitigation: 'Avoid eval.' } } },
            innerhtml_check: { group: 'script', points: 15, check: () => ({ value: 'Simulated Check', result: 'warn' }), 
                details: { he: { title: 'innerHTML ××¡×•×›×Ÿ', impact: 'XSS.', mitigation: '×”×©×ª××© ×‘-textContent.' }, en: { title: 'Dangerous innerHTML', impact: 'XSS.', mitigation: 'Use textContent.' } } },
            xss_url: { group: 'script', points: 10, check: () => ({ value: (location.href.includes('<') || location.hash.includes('<')), result: (location.href.includes('<') || location.hash.includes('<')) ? 'bad' : 'good' }),
                details: { he: { title: 'URL Injection', impact: 'Reflected XSS.', mitigation: '×¡× ×Ÿ ×§×œ×˜.' }, en: { title: 'URL Injection', impact: 'Reflected XSS.', mitigation: 'Filter inputs.' } } },
            dom_monitor: { group: 'script', points: 5, check: () => ({ value: window.MutationObserver ? 'Available' : 'Missing', result: window.MutationObserver ? 'good' : 'warn' }),
                details: { he: { title: '× ×™×˜×•×¨ DOM', impact: '×–×™×”×•×™ ×”×–×¨×§×•×ª.', mitigation: '×”×©×ª××© ×‘-MutationObserver.' }, en: { title: 'DOM Monitoring', impact: 'Injection detection.', mitigation: 'Use MutationObserver.' } } },

            // Input
            html5_validate: { group: 'input', points: 3, check: () => ({ value: 'Active', result: 'good' }), details: { he: { title: 'HTML5 Validation', impact: 'UX ×‘×œ×‘×“.', mitigation: '×”×©×ª××© ×‘-Attributes.' }, en: { title: 'HTML5 Validation', impact: 'UX only.', mitigation: 'Use Attributes.' } } },
            secure_cookie: { group: 'input', points: 10, check: () => ({ value: document.cookie.includes('Secure'), result: document.cookie.includes('Secure') ? 'good' : 'warn' }), details: { he: { title: 'Secure Cookie', impact: '×’× ×™×‘×ª ×¡×©×Ÿ.', mitigation: '×”×•×¡×£ Secure flag.' }, en: { title: 'Secure Cookie', impact: 'Session theft.', mitigation: 'Add Secure flag.' } } },
            storage_size: { group: 'input', points: 5, check: () => ({ value: `${localStorage.length} keys`, result: localStorage.length > 10 ? 'warn' : 'good' }), details: { he: { title: 'Local Storage', impact: '××™×“×¢ ××¢×§×‘.', mitigation: '× ×§×” ×ª×“×™×¨.' }, en: { title: 'Local Storage', impact: 'Tracking data.', mitigation: 'Clear often.' } } },
            gpc_check: { group: 'input', points: 2, check: () => ({ value: navigator.globalPrivacyControl === true, result: navigator.globalPrivacyControl === true ? 'good' : 'warn' }), details: { he: { title: 'GPC', impact: '×”×¢×“×¤×ª ×¤×¨×˜×™×•×ª.', mitigation: '×›×‘×“ ××ª ×”×“×’×œ.' }, en: { title: 'GPC', impact: 'Privacy pref.', mitigation: 'Honor flag.' } } },

            // FP
            canvas_fp: { group: 'fp', points: 15, check: () => ({ value: 'Simulated Hash', result: 'bad' }), details: { he: { title: 'Canvas FP', impact: '××¢×§×‘ ×™×™×—×•×“×™.', mitigation: '×× ×˜×™-FP ×ª×•×¡×£.' }, en: { title: 'Canvas FP', impact: 'Unique tracking.', mitigation: 'Anti-FP plugin.' } } },
            webgl_fp: { group: 'fp', points: 15, check: () => ({ value: 'Simulated Hash', result: 'bad' }), details: { he: { title: 'WebGL FP', impact: '××¢×§×‘ ×—×•××¨×”.', mitigation: '×“×¤×“×¤×Ÿ ×‘×˜×•×—.' }, en: { title: 'WebGL FP', impact: 'Hardware tracking.', mitigation: 'Secure browser.' } } },
            audio_fp: { group: 'fp', points: 10, check: () => ({ value: 'Simulated Hash', result: 'warn' }), details: { he: { title: 'Audio FP', impact: '××¢×§×‘ ××•×“×™×•.', mitigation: '×—×¡×™××ª API.' }, en: { title: 'Audio FP', impact: 'Audio tracking.', mitigation: 'Block API.' } } },
            timezone_leak: { group: 'fp', points: 3, check: () => ({ value: Intl.DateTimeFormat().resolvedOptions().timeZone, result: 'warn' }), details: { he: { title: 'Timezone Leak', impact: '××™×§×•×.', mitigation: '×©×™× ×•×™ ×–××Ÿ.' }, en: { title: 'Timezone Leak', impact: 'Location.', mitigation: 'Change time.' } } },
            timing_res: { group: 'fp', points: 8, check: () => ({ value: performance.now().toFixed(4) + 'ms', result: performance.now().toFixed(4) < 0.1 ? 'bad' : 'good' }), details: { he: { title: 'Timer Resolution', impact: 'Timing Attack.', mitigation: '×”×’×‘×œ×ª ×¨×–×•×œ×•×¦×™×”.' }, en: { title: 'Timer Resolution', impact: 'Timing Attack.', mitigation: 'Limit resolution.' } } },

            // Permissions
            geo_perm: { group: 'perms', points: 10, check: async () => { const state = await navigator.permissions.query({ name: 'geolocation' }).then(p => p.state); return { value: state, result: state === 'granted' ? 'bad' : 'good' }; }, details: { he: { title: 'Geolocation', impact: '××™×§×•× ×¤×™×–×™.', mitigation: '×—×¡×•×.' }, en: { title: 'Geolocation', impact: 'Physical loc.', mitigation: 'Block.' } } },
            clipboard_perm: { group: 'perms', points: 5, check: async () => { const state = await navigator.permissions.query({ name: 'clipboard-read' }).then(p => p.state); return { value: state, result: state === 'granted' ? 'warn' : 'good' }; }, details: { he: { title: 'Clipboard', impact: '×§×¨×™××ª ×”×¢×ª×§×•×ª.', mitigation: '×—×¡×•×.' }, en: { title: 'Clipboard', impact: 'Read copy.', mitigation: 'Block.' } } },
            camera_perm: { group: 'perms', points: 10, check: async () => { if (!navigator.mediaDevices) return { value: 'API Missing', result: 'good' }; const state = await navigator.permissions.query({ name: 'camera' }).then(p => p.state); return { value: state, result: state === 'granted' ? 'bad' : 'good' }; }, details: { he: { title: 'Camera', impact: '×¨×™×’×•×œ.', mitigation: '×—×¡×•×.' }, en: { title: 'Camera', impact: 'Spying.', mitigation: 'Block.' } } },

            // NetRT
            ip_leak: { group: 'netrt', points: 15, check: async () => ({ value: 'Simulated Check', result: Math.random() < 0.5 ? 'bad' : 'good' }), details: { he: { title: 'WebRTC IP Leak', impact: '×—×©×™×¤×ª IP.', mitigation: '× ×˜×¨×œ WebRTC.' }, en: { title: 'WebRTC IP Leak', impact: 'IP Reveal.', mitigation: 'Disable WebRTC.' } } },
            fetch_api: { group: 'netrt', points: 2, check: () => ({ value: 'Used', result: 'good' }), details: { he: { title: 'Fetch API', impact: 'HTTP.', mitigation: 'CORS.' }, en: { title: 'Fetch API', impact: 'HTTP.', mitigation: 'CORS.' } } },
            long_tasks: { group: 'netrt', points: 5, check: () => ({ value: '2 tasks', result: 'warn' }), details: { he: { title: 'Long Tasks', impact: '×‘×™×¦×•×¢×™×.', mitigation: '××•×¤×˜×™××™×–×¦×™×”.' }, en: { title: 'Long Tasks', impact: 'Perf.', mitigation: 'Optimize.' } } },
            js_errors: { group: 'netrt', points: 2, check: () => ({ value: window.onerror ? 'Monitored' : 'Missing', result: window.onerror ? 'good' : 'warn' }), details: { he: { title: 'JS Errors', impact: '×–×™×”×•×™ ×ª×§×œ×•×ª.', mitigation: 'Global Handler.' }, en: { title: 'JS Errors', impact: 'Detect bugs.', mitigation: 'Global Handler.' } } },
        };

        let lastScanData = null;

        function setLanguage(code) {
            Storage.set('csp_lang', code);
            const langData = LANG_LIST.find(l => l.code === code) || LANG_LIST.find(l => l.code === 'he');
            document.documentElement.lang = code;
            document.documentElement.dir = langData.dir;

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const dict = i18n[code] || i18n['en'];
                if (key) {
                    if (el.tagName === 'META' && el.name === 'description' && dict[key]) {
                        el.content = dict[key];
                    } else if (key === 'serverWarningList' && Array.isArray(dict[key])) {
                        const ul = el; ul.innerHTML = ''; 
                        dict[key].forEach(item => { const li = document.createElement('li'); li.textContent = item; ul.appendChild(li); });
                    } else if (dict[key]) {
                        el.textContent = dict[key];
                    }
                }
            });
        }

        function createResultLine(containerId, checkId, result, value, riskKey, scoreDeduction) {
            const container = $(containerId);
            const line = document.createElement('div');
            line.className = 'line';
            const langCode = document.documentElement.lang;
            const checkData = CHECKS[checkId];
            const dict = checkData.details[langCode] || checkData.details['en'];
            
            line.innerHTML = `<strong>${dict.title}</strong> 
                              <span>${escapeHTML(String(value))} <span class="badge ${riskKey}">${riskKey}</span></span>`;
            
            const detailsDiv = document.createElement('div');
            detailsDiv.className = `risk-detail ${riskKey}`;
            detailsDiv.innerHTML = `
                <h5>${dict.title} (Risk: ${riskKey})</h5>
                <p><strong>Impact:</strong> ${dict.impact}</p>
                <p><strong>Mitigation:</strong> ${dict.mitigation}</p>
            `;

            container.appendChild(line);
            container.appendChild(detailsDiv);
            return riskKey === 'bad' ? checkData.points : (riskKey === 'warn' ? checkData.points / 2 : 0);
        }

        // --- Download Logic (JSON Only) ---

        function downloadJSON() {
            if (!lastScanData) return alert("×× × ×‘×¦×¢ ×¡×¨×™×§×” ×§×•×“×.");
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(lastScanData, null, 2));
            triggerDownload(dataStr, `security-report-${new Date().toISOString().slice(0,10)}.json`);
        }

        function triggerDownload(dataStr, fileName) {
            const anchor = document.createElement('a');
            anchor.setAttribute("href", dataStr);
            anchor.setAttribute("download", fileName);
            document.body.appendChild(anchor);
            anchor.click();
            anchor.remove();
        }

        async function runScan() {
            logToConsole("Initializing Scan...");
            let currentScore = 100;
            const lang = document.documentElement.lang;
            
            // Initialize Report Data
            lastScanData = {
                timestamp: new Date().toISOString(),
                language: lang,
                results: [],
                score: 0
            };

            document.querySelectorAll('.results .list').forEach(list => list.innerHTML = '');

            for (const groupKey in CHECK_GROUPS) {
                for (const checkId of CHECK_GROUPS[groupKey]) {
                    const checkData = CHECKS[checkId];
                    const containerId = groupKey + 'List';
                    const dict = checkData.details[lang] || checkData.details['en'];

                    try {
                        const { value, result } = await checkData.check();
                        const deduction = createResultLine(containerId, checkId, result, value, result, checkData.points);
                        currentScore -= deduction;
                        
                        // Save to Report (Titles saved in the UI language at scan time)
                        lastScanData.results.push({
                            id: checkId,
                            title: dict.title, 
                            value: value, // The actual data from the browser
                            status: result,
                            impact: dict.impact,
                            mitigation: dict.mitigation
                        });

                        logToConsole(`[${groupKey}] ${checkId}: ${result}`);
                    } catch (e) {
                        logToConsole(`[ERROR] ${checkId}`, 'error');
                    }
                }
            }

            const finalScore = Math.max(0, currentScore);
            lastScanData.score = finalScore;
            
            $('privacyScore').textContent = finalScore;
            $('privacyScore').style.color = finalScore > 70 ? 'var(--good)' : (finalScore > 40 ? 'var(--warn)' : 'var(--bad)');
            
            // Show Download Button
            $('downloadJsonBtn').style.display = 'inline-flex';

            document.querySelectorAll('.card').forEach(c => c.classList.remove('expanded')); 
            document.querySelectorAll('.card').forEach(c => {
                if (c.querySelector('.bad, .warn')) c.classList.add('expanded');
            });
            
            logToConsole(`Scan Complete. Score: ${finalScore}. JSON export ready.`);
        }

        function initLanguage() {
            let savedLang = Storage.get('csp_lang');
            if (!savedLang) {
                const browserLang = navigator.language.split('-')[0];
                savedLang = LANG_LIST.find(l => l.code === browserLang) ? browserLang : 'he';
            }
            const sel = $('langSelector');
            LANG_LIST.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l.code;
                opt.textContent = l.name;
                sel.appendChild(opt);
            });
            sel.value = savedLang;
            setLanguage(savedLang);
            sel.addEventListener('change', (e) => setLanguage(e.target.value));
        }

        // Event Listeners
        $('fullBtn').addEventListener('click', runScan);
        $('downloadJsonBtn').addEventListener('click', downloadJSON);
        
        document.addEventListener('DOMContentLoaded', () => {
            initLanguage();
            if (!Storage.get('csp_consent')) $('cookieBanner').style.display = 'flex';
        });

        document.querySelectorAll('.toggle').forEach(el => {
            el.addEventListener('click', (e) => {
                const card = e.currentTarget.closest('.card');
                card.classList.toggle('expanded');
            });
        });

    </script>
</body>
</html>
